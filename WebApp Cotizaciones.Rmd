---
title: "Indicadores Ventas-COTIZACIONES"
author: "Marcos Granados"
date: "08 Julio 2023"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    collapsed: true
    smooth_scroll: true
github_repo: https://github.com/socraticboy/INDICADORES_VENTAS 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
pacman::p_load(terra, sf, fs, hablar, gcookbook, plotly, extrafont, RColorBrewer, rmapshaper, readxl, glue, hrbrthemes, tidyverse, leaflet, htmltools, leaflet.extras, DT, paletteer, packcircles, viridis, ggiraph)
```



```{r, include=FALSE}
BD <- read_excel(paste("BD ",today(),".xlsx", sep=""))
BD2 <- read_excel(paste("BD2 ", today(),".xlsx",sep=""))
```

# Cotizaciones INTERNAS

```{r, include=FALSE}
BD1 <- tibble(`FECHA SOLICITUD`=BD$`Marca temporal`,`Dirección de correo`=BD$`Dirección de correo electrónico`,Materia=BD$`1. Área solicitante`,
              Prioridad=BD$`0. Prioridad [Urgencia]`,`Razón Social`=BD$`4.1.1 Razón Social a la cual se dirige la cotización`,
              `Cliente frecuente`=BD$`Especifique al cliente`,Alerta=BD$Alerta,Estatus=BD$Estatus,Clave=BD$CLV,
              CANTIDAD=BD$CANT,VERSION=BD$VER,LIBERACION=BD$`Fecha de Liberación`)

```

```{r, include= FALSE, warning=FALSE,error=FALSE,cache=FALSE}
Cotizaciones_recepcionadas_por_día <- BD1 %>%
  filter(Alerta != "Control") %>%
  mutate(`FECHA SOLICITUD` = as.Date(`FECHA SOLICITUD`, format = "%d/%m/%y")) %>%
  group_by(`FECHA SOLICITUD`) %>%
  count(`FECHA SOLICITUD`) 

`Cotizaciones liberadas por día` <- BD1 %>%
  filter(Alerta != "Control") %>%
  group_by(LIBERACION) %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  summarise(NUMCOT = sum(CANTIDAD)) 

maximodiario_REC <- Cotizaciones_recepcionadas_por_día %>%   filter_all(all_vars(!is.na(.)))
maximodiario_LIB <- `Cotizaciones liberadas por día` %>%   filter_all(all_vars(!is.na(.)))
```

## Estadísticos rápidos 

En términos de solicitudes **INTERNAS** recibidas a través del formulario, hemos observado una variabilidad en los números diarios. El máximo de solicitudes en un solo día ha sido de **`r max(maximodiario_REC$n)`**, lo cual indica períodos de alta demanda. Por otro lado, el mínimo registrado ha sido de **`r min(maximodiario_REC$n)`** solicitud, lo que sugiere días más tranquilos. Sin embargo, el promedio diario se sitúa en **`r round(mean(maximodiario_REC$n),digits=2)`** solicitudes. 

Aunque existe cierta variabilidad, con una desviación estándar de $\mp$ $\pm$ **`r round(sd(maximodiario_REC$n), digits=2)`**, estos datos nos permiten gestionar adecuadamente el flujo de solicitudes internas y brindar un servicio eficiente a nuestros usuarios.


```{r, echo=FALSE}
boxplot(maximodiario_REC$n)
```

Por otro lado, es relevante mencionar el rango de cotizaciones **INTERNAS** elaboradas diariamente a través del formulario. El máximo registrado alcanza las **`r max(maximodiario_LIB$NUMCOT)`** cotizaciones en un solo día, lo cual demuestra nuestra capacidad para gestionar un volumen considerable de solicitudes. Por otro lado, el mínimo registrado es de **`r min(maximodiario_LIB$NUMCOT)`** cotización diaria, indicando que incluso en los días de menor demanda seguimos elaborando cotizaciones significativas.

En cuanto al promedio diario de cotizaciones **INTERNAS** elaboradas, este se sitúa en **`r round(mean(maximodiario_LIB$NUMCOT),digits=2)`** cotizaciones. Este valor refleja un flujo constante de solicitudes de cotización a través del formulario, lo cual es una muestra de la actividad regular en nuestro proceso de elaboración de cotizaciones. Cabe destacar que existe cierta variabilidad en la cantidad de cotizaciones diarias, evidenciada por la desviación estándar de $\pm$ **`r round(sd(maximodiario_LIB$NUMCOT), digits=2)`**. Esto implica que hay días en los que se elaboran más o menos cotizaciones en comparación con el promedio.

En conclusión, nuestra capacidad de elaborar cotizaciones **INTERNAS** a través del formulario se ha evidenciado en un máximo de **`r max(maximodiario_LIB$NUMCOT)`** cotizaciones en un día, mientras que el mínimo ha sido de **`r min(maximodiario_LIB$NUMCOT)`** cotización. Sin embargo, el promedio diario de **`r round(mean(maximodiario_LIB$NUMCOT),digits=2)`** cotizaciones nos muestra un flujo constante de solicitudes, aunque con cierta variabilidad en los números diarios.


```{r, echo=FALSE, warning=FALSE}
INTa <- ggplot(Cotizaciones_recepcionadas_por_día, aes(x = `FECHA SOLICITUD`, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D") +
  geom_line(data = `Cotizaciones liberadas por día`, aes(x = LIBERACION, y = NUMCOT), color = "red") +
  geom_point(data = `Cotizaciones liberadas por día`, aes(x = LIBERACION, y = NUMCOT), color = "black") +
  scale_y_continuous(limits = c(0, 120), sec.axis = sec_axis(~., name = "Número de cotizaciones liberadas")) +
  labs(title = paste("Número de cotizaciones liberadas por día (INT)", now()), x = "Mes", y = "Número total de solicitudes recepcionadas") +
  theme_minimal()

ggplotly(INTa)

```


```{r, include= FALSE}
`Solicitudes por materia` <- BD1 %>%
          count(Materia) %>%
          filter_all(all_vars(!is.na(.)))

Pendientes <- BD1 %>%
  count(Alerta) %>%
  filter_all(all_vars(!is.na(.)))  

`Pendientes por materia` <- BD1 %>%
  filter(Alerta != "Control") %>%
  count(Alerta,Materia) %>%
  filter_all(all_vars(!is.na(.)))  


`Cotizaciones liberadas por día` <- BD1 %>%
  filter(Alerta != "Control") %>%
  group_by(LIBERACION) %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  summarise(NUMCOT = sum(CANTIDAD))

Cotizaciones_recepcionadas_por_mes <- BD1 %>%
  filter(Alerta != "Control") %>%
  mutate(`FECHA SOLICITUD` = as.Date(`FECHA SOLICITUD`, format = "%d/%m/%y")) %>%
  group_by(MES = format(`FECHA SOLICITUD`, "%Y-%m")) %>%
  count(MES) %>%
  filter(!is.na(MES)) %>%
  mutate(FECHA = as.Date(paste(MES, "01", sep = "-")))


Cotizaciones_liberadas_por_mes <- BD1 %>%
  filter(Alerta != "Control") %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  group_by(MES = format(LIBERACION, "%Y-%m")) %>%
  summarise(NUMCOT = sum(CANTIDAD)) %>%
  filter(!is.na(NUMCOT)) %>%
  mutate(LIBERACION = as.Date(paste(MES, "01", sep = "-"))) %>%
  select(LIBERACION,NUMCOT,MES)


Cotizaciones_liberadas_por_mes_materia <- BD1 %>%
  filter(Alerta != "Control") %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  group_by(MES = format(LIBERACION, "%Y-%m"),Materia) %>%
  summarise(NUMCOT = sum(CANTIDAD)) %>%
  filter(!is.na(NUMCOT)) %>%
  mutate(LIBERACION = as.Date(paste(MES, "01", sep = "-"))) %>%
  select(LIBERACION,Materia,NUMCOT,MES)

```

## Indicadores {.tabset}

En la presente sección se agrupan los principales indicadores del bloque ventas encargado de **elaborar COTIZACIONES**. En cada una de las pestañas se podrán encontrar los gráficos y tablas de datos correspondientes a los siguientes indicadores:

- Desglose de solicitudes por Estatus
- Desglose de solicitudes por Materia
- Desglose de solicitudes recepcionadas por Mes
- Desglose de cotizaciones elaboradas por Mes
- Desglose de cotizaciones elaboradas por Mes y por Materia

Estos indicadores y su correspondiente análisis te brindarán una visión completa y detallada del desempeño del bloque de ventas en cuanto a la elaboración de cotizaciones, lo que te ayudará a tomar decisiones estratégicas y optimizar los procesos relacionados con la generación de cotizaciones.

### Desglose de solicitudes por Estatus 

```{r, echo = FALSE}
INTb <- ggplot(Pendientes, aes(x = Alerta, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D")+
  labs(x = "Mes", y = "Número de Solicitudes") +
  labs(title = paste("Número de solicitudes por estatus",now()))+
  theme_minimal()

ggplotly(INTb)

DT::datatable(Pendientes %>% arrange(desc(n)), rownames = FALSE)
```


### Desglose de solicitudes por Materia

```{r, echo = FALSE, fig.width = 9, fig.height = 5}


data <- `Solicitudes por materia` %>% select(group=Materia, value=n) 
data$text <- paste("Materia: ",data$group, "\n", "Número de solicitudes:", data$value)

# Generate the layout
packing <- circleProgressiveLayout(data$value, sizetype='area')
packing$radius <- 0.95*packing$radius
data <- cbind(data, packing)
dat.gg <- circleLayoutVertices(packing, npoints=50)
dat.gg$value <- rep(data$value, each=51)

# Plot 
INTc <- ggplot() + 
  geom_polygon_interactive(data = dat.gg, aes(x, y, group = id, fill=value, tooltip = data$text[id], data_id = id), colour = "black", alpha = 0.6) +
  scale_fill_distiller(palette = "BuPu", direction = 1 ) +
  geom_text(data = data, aes(x, y, label = gsub("Group_", "", group)), size=3, color="black") +
  theme_void() + 
  theme(legend.position="none", plot.margin=unit(c(0,0,0,0),"cm") ) + 
  coord_equal()


girafe(ggobj = INTc, width_svg = 7, height_svg = 7)

DT::datatable(`Solicitudes por materia` %>% arrange(desc(n)), rownames = FALSE)
```


### Desglose de solicitudes por Materia (Opción B)

```{r, echo=FALSE}

ggplot(`Solicitudes por materia`, aes(x="", y=n, fill=Materia)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
   theme_void()+
  scale_fill_manual(values = paletteer_dynamic("cartography::pastel.pal", 18))

DT::datatable(`Solicitudes por materia` %>% arrange(desc(n)), rownames = FALSE)

```


### Desglose de solicitudes recepcionadas por Mes

```{r, echo = FALSE}

ggplot(Cotizaciones_recepcionadas_por_mes, aes(x = MES, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D")+
  labs(x = "Mes", y = "Número de Cotizaciones") +
  labs(title = paste("Número de cotizaciones recep vs lib por mes (INT)",now()), x = "Mes", y = "Número total de cotizaciones")+
  theme_minimal()


DT::datatable(Cotizaciones_recepcionadas_por_mes %>% select(MES, n) %>% arrange(desc(MES)), rownames = FALSE)
```

### Desglose de cotizaciones elaboradas por Mes

```{r, echo = FALSE}
ggplot(Cotizaciones_recepcionadas_por_mes, aes(x = MES, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D") +
  geom_line(data = Cotizaciones_liberadas_por_mes, aes(x = MES, y = NUMCOT, group=1), color = "red") +
  geom_point(data = Cotizaciones_liberadas_por_mes, aes(x = MES, y = NUMCOT, group=1), color = "black") +
  labs(x = "Mes", y = "Número de Cotizaciones") +
  labs(title = paste("Número de cotizaciones recep vs lib por mes (INT)",now()), x = "Mes", y = "Número total de cotizaciones")+
  theme_minimal()


DT::datatable(Cotizaciones_liberadas_por_mes %>% select(MES,NUMCOT) %>% arrange(desc(MES)), rownames = FALSE)
```

### Desglose de cotizaciones elaboradas por Mes y por Materia

```{r, echo = FALSE}

DT::datatable(Cotizaciones_liberadas_por_mes_materia %>% select(MES,Materia,NUMCOT) %>% arrange(desc(MES)), rownames = FALSE)
```



# Cotizaciones EXTERNAS 

```{r, include=FALSE}
BD2 <- tibble(`FECHA SOLICITUD`=BD2$`Marca temporal`,
              `Dirección de correo`=BD2$`Dirección de correo electrónico`,
              `Razón Social`=BD2$`3.1 Razón Social a la cual se dirige la cotización`,
              Alerta=BD2$Alerta,
              Estatus=BD2$Estatus...40,
              Clave=BD2$CLV,
              CANTIDAD=BD2$CANT,
              VERSION=BD2$VER,
              LIBERACION=BD2$`Fecha de Liberación`)

PendientesEXT <- BD2 %>%
  count(Alerta) %>%
  filter_all(all_vars(!is.na(.)))  

`Cotizaciones liberadas por día EXT` <- BD2 %>%
  group_by(LIBERACION) %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  summarise(NUMCOT = sum(CANTIDAD))


Cotizaciones_recepcionadas_por_mes_EXT <- BD2 %>%
  mutate(`FECHA SOLICITUD` = as.Date(`FECHA SOLICITUD`, format = "%d/%m/%y")) %>%
  group_by(MES = format(`FECHA SOLICITUD`, "%Y-%m")) %>%
  count(MES) %>%
  filter(!is.na(MES)) %>%
  mutate(FECHA = as.Date(paste(MES, "01", sep = "-")))

Cotizaciones_liberadas_por_mes_EXT <- BD2 %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y")) %>%
  group_by(MES = format(LIBERACION, "%Y-%m")) %>%
  summarise(NUMCOT = sum(CANTIDAD)) %>%
  filter(!is.na(NUMCOT)) %>%
  mutate(LIBERACION = as.Date(paste(MES, "01", sep = "-"))) %>%
  select(LIBERACION,NUMCOT,MES)

Cotizaciones_recepcionadas_por_día_EXT <- BD2 %>%
  mutate(`FECHA SOLICITUD` = as.Date(`FECHA SOLICITUD`, format = "%d/%m/%y")) %>%
  group_by(`FECHA SOLICITUD`) %>%
  count(`FECHA SOLICITUD`) 

`Cotizaciones liberadas por día EXT` <- BD2 %>%
  group_by(LIBERACION) %>%
  mutate(LIBERACION = as.Date(LIBERACION, format = "%d/%m/%y"))%>%
  summarise(NUMCOT = sum(CANTIDAD))


maximodiarioEXT_REC <- Cotizaciones_recepcionadas_por_día_EXT %>%   filter_all(all_vars(!is.na(.)))
maximodiarioEXT_LIB <- `Cotizaciones liberadas por día EXT` %>%   filter_all(all_vars(!is.na(.)))
```

## Estadísticos rápidos 

En términos de solicitudes **EXTERNAS** recibidas a través del formulario, hemos observado una variabilidad en los números diarios. El máximo de solicitudes en un solo día ha sido de **`r max(maximodiarioEXT_REC$n)`**, lo cual indica períodos de alta demanda. Por otro lado, el mínimo registrado ha sido de **`r min(maximodiarioEXT_REC$n)`** solicitud, lo que sugiere días más tranquilos. Sin embargo, el promedio diario se sitúa en **`r round(mean(maximodiarioEXT_REC$n),digits=2)`** solicitudes. 

Aunque existe cierta variabilidad, con una desviación estándar de $\pm$ **`r round(sd(maximodiarioEXT_REC$n), digits=2)`**, estos datos nos permiten gestionar adecuadamente el flujo de solicitudes internas y brindar un servicio eficiente a nuestros usuarios.


```{r, echo=FALSE}
boxplot(maximodiarioEXT_REC$n)
```


En relación a las cotizaciones **EXTERNAS** elaboradas a través del formulario, es importante destacar tanto los valores máximos como los mínimos registrados. El número máximo de cotizaciones **EXTERNAS** elaboradas en un solo día ha sido de **`r max(maximodiarioEXT_LIB$NUMCOT)`**, lo cual evidencia momentos de mayor demanda y actividad en nuestro proceso de cotización. Por otro lado, el mínimo registrado es de **`r min(maximodiarioEXT_LIB$NUMCOT)`** cotización externa en un día, lo que demuestra que incluso en días más tranquilos seguimos atendiendo y elaborando cotizaciones relevantes para nuestros clientes.

En cuanto al promedio diario de cotizaciones **EXTERNAS** elaboradas, este se sitúa en **`r round(mean(maximodiarioEXT_LIB$NUMCOT),digits=2)`** cotizaciones. Esta cifra refleja un flujo constante de solicitudes de cotización externa a través del formulario, lo que indica que nuestro sistema de elaboración de cotizaciones se mantiene activo y en uso regular. Es importante tener en cuenta que existe cierta variabilidad en la cantidad de cotizaciones diarias, como lo indica la desviación estándar de $\pm$ **`r round(sd(maximodiarioEXT_LIB$NUMCOT), digits=2)`**. Esto implica que algunos días recibimos una cantidad notablemente mayor o menor de cotizaciones en comparación con el promedio.


```{r, echo=FALSE,warning=FALSE}

EXTa <- ggplot(Cotizaciones_recepcionadas_por_día_EXT, aes(x = `FECHA SOLICITUD`, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D") +
  geom_line(data = `Cotizaciones liberadas por día EXT`, aes(x = LIBERACION, y = NUMCOT), color = "red") +
  geom_point(data = `Cotizaciones liberadas por día EXT`, aes(x = LIBERACION, y = NUMCOT), color = "black") +
  scale_y_continuous(limits = c(0, 15))+
  labs(title = paste("Número de cotizaciones liberadas por día (EXT)",now()), x = "Mes", y = "Número total de cotizaciones")+
  theme_minimal()

ggplotly(EXTa)
```

## Indicadores {.tabset}

En esta sección, se recopilan los indicadores clave del bloque de ventas encargado de la **elaboración de cotizaciones**. En cada una de las pestañas, encontrarás gráficos y tablas de datos relacionados con los siguientes indicadores:

- Desglose de solicitudes por Estatus
- Desglose de solicitudes recepcionadas por Mes
- Desglose de cotizaciones elaboradas por Mes


### Desglose de solicitudes por Estatus 

```{r, echo=FALSE, include=TRUE, message = FALSE, warning=FALSE, fig.width = 4, fig.height = 2, fig.align = 'center'}
EXTb <- ggplot(PendientesEXT, aes(x = Alerta, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D")+
  labs(x = "Mes", y = "Número de Solicitudes") +
  labs(title = paste("Número de solicitudes por estatus",now()))+
  theme_minimal()
```


```{r, echo=FALSE, include=TRUE, message = FALSE, warning=FALSE, fig.width = 7, fig.height = 5, fig.align = 'center'}
ggplotly(EXTb)
```


```{r, echo=FALSE, include=TRUE, message = FALSE, warning=FALSE, fig.width = 4, fig.height = 2, fig.align = 'center'}
DT::datatable(PendientesEXT %>% arrange(desc(n)), rownames = FALSE)

```

### Desglose de solicitudes recepcionadas por Mes

```{r, echo=FALSE, include=TRUE, message = FALSE, warning=FALSE, fig.width = 7, fig.height = 5, fig.align = 'center'}

ggplotly(ggplot(Cotizaciones_recepcionadas_por_mes_EXT, aes(x = MES, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D")+
  labs(x = "Mes", y = "Número de Cotizaciones") +
  labs(title = paste("Número de cotizaciones recep vs lib por mes (INT)",now()), x = "Mes", y = "Número total de cotizaciones")+
  theme_minimal())
```




```{r, echo=FALSE}
DT::datatable(Cotizaciones_recepcionadas_por_mes_EXT %>% select(MES, n) %>% arrange(desc(MES)), rownames = FALSE)
```



### Desglose de cotizaciones elaboradas por Mes

```{r, echo = FALSE}
ggplot(Cotizaciones_recepcionadas_por_mes_EXT, aes(x = MES, y = n)) +
  geom_bar(stat = "identity", fill = "#418E4D") +
  geom_line(data = Cotizaciones_liberadas_por_mes_EXT, aes(x = MES, y = NUMCOT, group=1), color = "red") +
  geom_point(data = Cotizaciones_liberadas_por_mes_EXT, aes(x = MES, y = NUMCOT, group=1), color = "black") +
  labs(x = "Mes", y = "Número de Cotizaciones") +
  labs(title = paste("Número de cotizaciones liberadas por mes y materia (EXT)",now()), x = "Mes", y = "Número total de cotizaciones")+
  theme_minimal() + scale_y_continuous(limits = c(0, 105))


DT::datatable(Cotizaciones_liberadas_por_mes_EXT %>% select(MES,NUMCOT) %>% arrange(desc(MES)), rownames = FALSE)
```